---
title: "Osa Conservation Camera Trap Network"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: bookdown::gitbook
documentclass: book
biblio-style: apalike
link-citations: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(googlesheets4)
library(dplyr)
library(leaflet)
library(DT)  
library(ggplot2)

#gs4_auth()

google_creds <- Sys.getenv("GOOGLE_AUTHENTICATION_CREDENTIALS")

if (google_creds != "") {
  # Running in GitHub Actions — use service account
  creds_file <- tempfile(fileext = ".json")
  writeLines(google_creds, creds_file)
  gs4_auth(path = creds_file)
} else {
  # Running locally — use interactive OAuth
  gs4_auth()
}


# Sheet IDs (from the URL: /spreadsheets/d/SHEET_ID/edit) 
projects_id    <- "1LXRDFnJ1dQKpc3I5d_YGNvpKYSHL1pn1NvRzoOpr7aA"
cameras_id     <- "1iVzfexgoIjGL4pubrLDrk3KBgRGSCsixZB6T8DljN2E"
locations_id   <- "1C5zbG5-Dm7BhAI0VYMyXf-p7HtmlviqqV62wImn0Y9Q"
deployments_id <- "1BGsVa_3ZRr4hxqCG-imqG4UB2voU9UJpB3Nbdk8yTD8"

# Fetch data ----------------------------------------------
projects    <- read_sheet(projects_id)
cameras     <- read_sheet(cameras_id)
locations   <- read_sheet(locations_id)
deployments <- read_sheet(deployments_id)

```

# Overview

Summary stats here — number of active cameras, projects, deployments, etc.
```{r}
# e.g.
cat(nrow(locations), "camera locations across", n_distinct(projects$project_name), "projects")
```

```{r}

map_data <- locations %>%
  left_join(deployments, by = "camera_location") %>%
  filter(!is.na(latitude), !is.na(longitude)) %>%
  mutate(
    camera_location = sapply(camera_location, as.character),
    project_name    = sapply(project_name,    as.character),
    latitude        = as.numeric(unlist(latitude)),
    longitude       = as.numeric(unlist(longitude))
  )

# Create a colour palette based on project_name
projects_palette <- colorFactor(
  palette = "Set1",
  domain  = map_data$project_name
)

# Build a named list of project groups for the layer control
project_groups <- unique(map_data$project_name)

# Remove the NA
project_groups <- project_groups[is.na(project_groups)==F] 

# Base map
m <- leaflet(map_data) %>%
  addProviderTiles("Esri.WorldImagery", group = "Satellite") %>%
  addProviderTiles("OpenStreetMap",     group = "Street") %>%
  addLayersControl(
    baseGroups   = c("Satellite", "Street"),
    overlayGroups = project_groups,
    options = layersControlOptions(collapsed = FALSE)
  )

# Add a separate layer for each project
for (proj in project_groups) {
  proj_data <- map_data %>% filter(project_name == proj)
  m <- m %>%
    addCircleMarkers(
      data        = proj_data,
      group       = proj,
      lng         = ~longitude,
      lat         = ~latitude,
      label       = ~camera_location,
      popup       = ~paste0(
        "<b>Location:</b> ", camera_location, "<br>",
        "<b>Project:</b> ",  project_name,    "<br>",
        "<b>Lat:</b> ",      round(latitude,  5), "<br>",
        "<b>Lon:</b> ",      round(longitude, 5)
      ),
      color       = "white",
      fillColor   = ~projects_palette(project_name),
      fillOpacity = 0.85,
      radius      = 6,
      weight      = 1
    )
}

# Add legend
m <- m %>%
  addLegend(
    position = "bottomright",
    pal      = projects_palette,
    values   = map_data$project_name,
    title    = "Project"
  )

m
```

# Project data

```{r}
datatable(projects, filter = "top", rownames = FALSE)
```


```{r}
datatable(cameras, filter = "top", rownames = FALSE)
```

```{r}
datatable(deployments, filter = "top", rownames = FALSE)
```
